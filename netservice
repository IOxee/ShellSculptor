#!/bin/bash

if [ "$#" -lt 3 ]; then
    echo "Usage: $0 <service_name> <executable_path> <working_directory> [service_description]"
    exit 1
fi

SERVICE_NAME="$1"
RELATIVE_EXECUTABLE_PATH="$2"
RELATIVE_WORKING_DIRECTORY="$3"
SERVICE_DESCRIPTION="${4:-'Service generated by script'}"
ABSOLUTE_EXECUTABLE_PATH=$(realpath "$RELATIVE_EXECUTABLE_PATH")
ABSOLUTE_WORKING_DIRECTORY=$(realpath "$RELATIVE_WORKING_DIRECTORY")
SERVICE_FILE="/etc/systemd/system/$SERVICE_NAME.service"

echo "Creating service file for $SERVICE_NAME..."
cat << EOF > "$SERVICE_FILE"
[Unit]
Description=$SERVICE_DESCRIPTION
After=network.target

[Service]
ExecStart=/usr/bin/dotnet $ABSOLUTE_EXECUTABLE_PATH
WorkingDirectory=$ABSOLUTE_WORKING_DIRECTORY
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

echo "Enabling and starting the service..."
systemctl daemon-reload
systemctl enable "$SERVICE_NAME"
systemctl start "$SERVICE_NAME"

echo "Service $SERVICE_NAME created and started."
